#!/command/with-contenv bash
# Unified backup script for moltbot state using s3cmd sync
# Usage: 
#   moltbot-backup                    # Backup all default paths
#   moltbot-backup --path /some/dir   # Backup specific path
#   moltbot-backup --quiet            # Suppress output

set -e

QUIET=""
CUSTOM_PATH=""
EXCLUDE_ARGS=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --quiet|-q)
      QUIET="true"
      shift
      ;;
    --path|-p)
      CUSTOM_PATH="$2"
      shift 2
      ;;
    --exclude|-e)
      EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: moltbot-backup [--quiet] [--path /some/dir] [--exclude pattern]"
      exit 1
      ;;
  esac
done

log() {
  if [ "$QUIET" != "true" ]; then
    echo "[backup] $1"
  fi
}

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  log "Persistence not configured, skipping"
  exit 0
fi

# Ensure s3cmd config exists
ensure_s3cfg() {
  if [ ! -f /tmp/.s3cfg ]; then
    cat > /tmp/.s3cfg << EOF
[default]
access_key = ${LITESTREAM_ACCESS_KEY_ID}
secret_key = ${LITESTREAM_SECRET_ACCESS_KEY}
host_base = ${SPACES_ENDPOINT}
host_bucket = %(bucket)s.${SPACES_ENDPOINT}
use_https = True
EOF
    chmod 600 /tmp/.s3cfg
  fi
}

# Backup a single path using s3cmd sync
# Args: $1 = source path, $2 = s3 key prefix, $3 = extra exclude args (optional)
backup_path() {
  local src_path="$1"
  local key_prefix="$2"
  local extra_excludes="${3:-}"
  
  if [ ! -d "$src_path" ]; then
    log "Path $src_path does not exist, skipping"
    return 0
  fi
  
  log "Syncing $src_path to s3://${SPACES_BUCKET}/moltbot/${key_prefix}/..."
  
  # Build s3cmd sync command
  # --delete-removed: remove files from S3 that no longer exist locally
  # --no-preserve: don't try to preserve permissions (not supported by S3)
  s3cmd -c /tmp/.s3cfg sync \
    --delete-removed \
    --no-preserve \
    $extra_excludes \
    $EXCLUDE_ARGS \
    "${src_path}/" "s3://${SPACES_BUCKET}/moltbot/${key_prefix}/" && \
    log "$src_path synced successfully" || \
    log "Warning: $src_path sync failed"
}

# Generate key prefix from path (e.g., /home/moltbot -> home-moltbot)
path_to_key() {
  local path="$1"
  # Remove leading slash, replace remaining slashes with dashes
  echo "${path#/}" | tr '/' '-' | sed 's/-*$//'
}

ensure_s3cfg

# If custom path specified, backup just that
if [ -n "$CUSTOM_PATH" ]; then
  key_prefix="$(path_to_key "$CUSTOM_PATH")"
  backup_path "$CUSTOM_PATH" "$key_prefix"
  log "Backup complete"
  exit 0
fi

# Default: backup all known paths
backup_path "$MOLTBOT_STATE_DIR" "state" "--exclude=memory/* --exclude=*.sqlite* --exclude=*.db* --exclude=gateway.*.lock"
backup_path "$TS_STATE_DIR" "tailscale"
backup_path "/home" "home" "--exclude=*/.cache/* --exclude=*/.npm/_cacache/* --exclude=*/.local/share/pnpm/store/* --exclude=*/node_modules/*"

log "Backup complete"
