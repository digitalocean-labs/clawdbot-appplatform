#!/command/with-contenv bash
# Unified backup script for moltbot state using s3cmd sync
# Syncs to s3://bucket/moltbot/rootfs/ preserving filesystem paths
#
# Usage: 
#   moltbot-backup                    # Backup all default paths
#   moltbot-backup --path /some/dir   # Backup specific path
#   moltbot-backup --quiet            # Suppress output

set -e

QUIET=""
CUSTOM_PATH=""
EXCLUDE_ARGS=""
S3_PREFIX="moltbot/rootfs"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --quiet|-q)
      QUIET="true"
      shift
      ;;
    --path|-p)
      CUSTOM_PATH="$2"
      shift 2
      ;;
    --exclude|-e)
      EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: moltbot-backup [--quiet] [--path /some/dir] [--exclude pattern]"
      exit 1
      ;;
  esac
done

log() {
  if [ "$QUIET" != "true" ]; then
    echo "[backup] $1"
  fi
}

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  log "Persistence not configured, skipping"
  exit 0
fi

# Ensure s3cmd config exists
ensure_s3cfg() {
  if [ ! -f /tmp/.s3cfg ]; then
    cat > /tmp/.s3cfg << EOF
[default]
access_key = ${LITESTREAM_ACCESS_KEY_ID}
secret_key = ${LITESTREAM_SECRET_ACCESS_KEY}
host_base = ${SPACES_ENDPOINT}
host_bucket = %(bucket)s.${SPACES_ENDPOINT}
use_https = True
EOF
    chmod 600 /tmp/.s3cfg
  fi
}

# Backup a single path using s3cmd sync
# Preserves filesystem path structure: /home -> s3://bucket/moltbot/rootfs/home/
# Args: $1 = source path, $2 = extra exclude args (optional)
backup_path() {
  local src_path="$1"
  local extra_excludes="${2:-}"
  
  if [ ! -d "$src_path" ]; then
    log "Path $src_path does not exist, skipping"
    return 0
  fi
  
  # Remove leading slash for S3 path
  local s3_path="${src_path#/}"
  
  log "Syncing $src_path to s3://${SPACES_BUCKET}/${S3_PREFIX}/${s3_path}/..."
  
  # Build s3cmd sync command
  # --delete-removed: remove files from S3 that no longer exist locally
  # --no-preserve: don't try to preserve permissions (not supported by S3)
  s3cmd -c /tmp/.s3cfg sync \
    --delete-removed \
    --no-preserve \
    $extra_excludes \
    $EXCLUDE_ARGS \
    "${src_path}/" "s3://${SPACES_BUCKET}/${S3_PREFIX}/${s3_path}/" && \
    log "$src_path synced successfully" || \
    log "Warning: $src_path sync failed"
}

ensure_s3cfg

# If custom path specified, backup just that
if [ -n "$CUSTOM_PATH" ]; then
  backup_path "$CUSTOM_PATH"
  log "Backup complete"
  exit 0
fi

# Default: backup all known paths
backup_path "$MOLTBOT_STATE_DIR" "--exclude=memory/* --exclude=*.sqlite* --exclude=*.db* --exclude=gateway.*.lock"
backup_path "$TS_STATE_DIR"
backup_path "/home" "--exclude=*/.cache/* --exclude=*/.npm/_cacache/* --exclude=*/.local/share/pnpm/store/* --exclude=*/node_modules/*"

log "Backup complete"
