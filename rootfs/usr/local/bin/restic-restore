#!/command/with-contenv bash
# Unified restore script using restic
# Reads configuration from /etc/moltbot/backup.yaml
#
# Restore order:
# 1. Restore dpkg-selections file
# 2. Reinstall packages
# 3. Restore /etc (first in config, overlays package defaults)
# 4. Restore remaining paths

set -e

CONFIG_FILE="/etc/moltbot/backup.yaml"
DPKG_SELECTIONS="/etc/moltbot/dpkg-selections"
QUIET=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --quiet|-q)
      QUIET=1
      shift
      ;;
    *)
      shift
      ;;
  esac
done

log() {
  [ -z "$QUIET" ] && echo "[restore] $1"
}

# Check if persistence is configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  log "Persistence not configured, skipping restore"
  exit 0
fi

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
  log "Config file not found: $CONFIG_FILE"
  exit 1
fi

# Check if repository has any snapshots
if ! restic snapshots --latest 1 2>/dev/null | grep -q .; then
  log "No snapshots found in repository, skipping restore"
  exit 0
fi

# Step 1: Restore dpkg-selections file first
log "Restoring package selections..."
if restic restore latest --target / --include "$DPKG_SELECTIONS" 2>&1; then
  log "Package selections restored"
else
  log "Warning: Could not restore package selections (continuing)"
fi

# Step 2: Reinstall packages if selections file exists
if [ -f "$DPKG_SELECTIONS" ]; then
  log "Reinstalling packages from saved selections..."
  dpkg --set-selections < "$DPKG_SELECTIONS"
  apt-get update -qq
  apt-get dselect-upgrade -y -qq || log "Warning: Some packages may have failed to install"
  log "Package reinstallation complete"
else
  log "No package selections found, skipping package restore"
fi

# Step 3 & 4: Restore all paths in order (config has /etc first)
PATH_COUNT=$(yq -r '.paths | length' "$CONFIG_FILE")

if [ "$PATH_COUNT" -eq 0 ]; then
  log "No paths configured for restore"
  exit 0
fi

log "Restoring $PATH_COUNT paths..."

for i in $(seq 0 $((PATH_COUNT - 1))); do
  RESTORE_PATH=$(yq -r ".paths[$i].path" "$CONFIG_FILE")
  
  # Ensure parent directory exists
  mkdir -p "$(dirname "$RESTORE_PATH")"
  
  log "Restoring: $RESTORE_PATH"
  
  # Run restic restore with --include to restore only this path
  # --target / restores to original locations
  if restic restore latest --target / --include "$RESTORE_PATH" 2>&1; then
    log "Completed: $RESTORE_PATH"
  else
    log "Warning: Restore may have had issues for $RESTORE_PATH (continuing)"
  fi
done

log "Restore complete"
