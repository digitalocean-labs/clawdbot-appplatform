#!/command/with-contenv bash
# Fix permissions on s6-overlay directories and scripts

echo "[permissions] Fixing s6-overlay script permissions"

# /etc/cont-init.d - directory should be 755, scripts should be executable
if [ -d /etc/cont-init.d ]; then
  chmod 755 /etc/cont-init.d
  chown root:root /etc/cont-init.d
  # Make all scripts executable (files with shebang)
  find /etc/cont-init.d -type f | while read -r script; do
    if [ -f "$script" ] && head -n 1 "$script" 2>/dev/null | grep -q "^#!"; then
      chmod 755 "$script"
      chown root:root "$script"
    fi
  done
fi

# /etc/services.d - directory should be 755
if [ -d /etc/services.d ]; then
  chmod 755 /etc/services.d
  chown root:root /etc/services.d
fi

# /etc/cont-finish.d - directory should be 755, scripts should be executable
if [ -d /etc/cont-finish.d ]; then
  chmod 755 /etc/cont-finish.d
  chown root:root /etc/cont-finish.d
  # Make all scripts executable (files with shebang)
  find /etc/cont-finish.d -type f | while read -r script; do
    if [ -f "$script" ] && head -n 1 "$script" 2>/dev/null | grep -q "^#!"; then
      chmod 755 "$script"
      chown root:root "$script"
    fi
  done
fi
