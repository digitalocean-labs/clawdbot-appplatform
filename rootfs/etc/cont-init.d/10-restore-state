#!/command/with-contenv bash
# Restore state from DO Spaces backup using s3cmd sync

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  echo "[restore-state] Persistence not configured, skipping"
  exit 0
fi

echo "[restore-state] Restoring state from Spaces..."

S3_PREFIX="s3://${SPACES_BUCKET}/moltbot/rootfs"

# Ensure directories exist
mkdir -p "$MOLTBOT_STATE_DIR" "$MOLTBOT_WORKSPACE_DIR" "$TS_STATE_DIR"

# Restore moltbot state
if s3cmd -c /tmp/.s3cfg ls "${S3_PREFIX}/data/.moltbot/" 2>/dev/null | grep -q .; then
  echo "[restore-state] Restoring moltbot state..."
  s3cmd -c /tmp/.s3cfg sync --no-preserve \
    "${S3_PREFIX}/data/.moltbot/" "$MOLTBOT_STATE_DIR/" || \
    echo "[restore-state] Warning: moltbot state restore failed"
else
  echo "[restore-state] No moltbot state backup found"
fi

# Restore Tailscale state
if s3cmd -c /tmp/.s3cfg ls "${S3_PREFIX}/data/tailscale/" 2>/dev/null | grep -q .; then
  echo "[restore-state] Restoring Tailscale state..."
  s3cmd -c /tmp/.s3cfg sync --no-preserve \
    "${S3_PREFIX}/data/tailscale/" "$TS_STATE_DIR/" || \
    echo "[restore-state] Warning: Tailscale state restore failed"
else
  echo "[restore-state] No Tailscale state backup found"
fi

# Restore home directories
if s3cmd -c /tmp/.s3cfg ls "${S3_PREFIX}/home/" 2>/dev/null | grep -q .; then
  echo "[restore-state] Restoring home directories..."
  s3cmd -c /tmp/.s3cfg sync --no-preserve \
    "${S3_PREFIX}/home/" "/home/" || \
    echo "[restore-state] Warning: home restore failed"
else
  echo "[restore-state] No home backup found"
fi

echo "[restore-state] Restore complete"
