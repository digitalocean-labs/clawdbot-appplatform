#!/command/with-contenv bash
# Setup SSH directories and permissions for all users

echo "[ssh-setup] Setting up SSH directories for all users"

# Iterate through all home directories in /home
for homedir in /home/*; do
  # Skip if not a directory
  [ ! -d "$homedir" ] && continue
  
  # Get username from path
  username=$(basename "$homedir")
  
  # Skip if user doesn't exist
  id "$username" >/dev/null 2>&1 || continue
  
  # Create .ssh directory if it doesn't exist
  sshdir="$homedir/.ssh"
  if [ ! -d "$sshdir" ]; then
    mkdir -p "$sshdir"
    echo "[ssh-setup] Created .ssh directory for $username"
  fi
  
  # Set proper permissions on .ssh directory
  chmod 700 "$sshdir"
  chown "$username:$username" "$sshdir"
  
  # Create authorized_keys file if it doesn't exist
  authkeys="$sshdir/authorized_keys"
  if [ ! -f "$authkeys" ]; then
    touch "$authkeys"
    chmod 600 "$authkeys"
    chown "$username:$username" "$authkeys"
    echo "[ssh-setup] Created authorized_keys for $username"
  else
    # Ensure existing authorized_keys has correct permissions
    chmod 600 "$authkeys"
    chown "$username:$username" "$authkeys"
  fi
done
