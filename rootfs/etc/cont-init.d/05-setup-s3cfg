#!/command/with-contenv bash
# Setup s3cmd configuration for DO Spaces

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  echo "[setup-s3cfg] Persistence not configured, skipping"
  exit 0
fi

echo "[setup-s3cfg] Configuring s3cmd for DO Spaces..."

# Create secure directory (root-only, in-memory tmpfs)
mkdir -p /run/secrets
chmod 700 /run/secrets

cat > /run/secrets/s3cfg << EOF
[default]
access_key = ${LITESTREAM_ACCESS_KEY_ID}
secret_key = ${LITESTREAM_SECRET_ACCESS_KEY}
host_base = ${SPACES_ENDPOINT}
host_bucket = %(bucket)s.${SPACES_ENDPOINT}
use_https = True
EOF
chmod 600 /run/secrets/s3cfg

echo "[setup-s3cfg] s3cmd configured"
